@page
@using Microsoft.AspNetCore.Mvc.Localization
@using Microsoft.Extensions.Localization
@using Volo.Abp.Account.Localization
@using Volo.Abp.Account.Settings
@using Volo.Abp.AspNetCore.Mvc.UI.MultiTenancy.Localization
@using Volo.Abp.Settings
@using AspNetCore.ReCaptcha
@model PolpAbp.Presentation.Account.Web.Pages.Account.AuthorizeSuccessModel
@inject IHtmlLocalizer<AccountResource> L
@{
    ViewBag.Title = "Authorization Successful";
    ViewBag.Description = "You are now logged in and can access the system.";
    ViewBag.Keywords = "authorization successful";
}

@section docReady {
    <script type="text/javascript">
        function postCordovaMessage() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const scope = urlParams.get('scope');
            /* Send an action = 'close' JSON object to Cordova via postMessage API */
            var message = { action: 'close', code: code, scope: scope };
            if (!webkit || !webkit.messageHandlers || !webkit.messageHandlers.cordova_iab) {
                console.warn('Cordova IAB postMessage API not found!');
                // throw 'Cordova IAB postMessage API not found!';
            } else {
                console.log('Message sent!');
                webkit.messageHandlers.cordova_iab.postMessage(JSON.stringify(message));
            }
        }
        function logoutUser() {
            try {
                $.ajax({
                    url: "/account/logout",
                    type: 'POST',
                    success: function (response) {
                        // Handle successful logout response here
                        // This could be a message or redirecting to login page
                        console.log("Successfully logged out!");
                        postCordovaMessage();
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        // Handle errors during logout
                        console.error("Error logging out!", textStatus, errorThrown);
                        postCordovaMessage();
                    }                   
                });
            } catch (ex) { 
                // todo: 
                console.error("Unexpected error during logout:", error);
            }
        }
    </script>

}

<h4 class="mb-4 fw-semibold">
    Authorization Successful
</h4>

<p>
    You are now logged in and can access the system. Please close this page to continue!
</p>

@if (Model.IsCordovaEnabled)
{
    <div class="d-grid gap-2">
        <a abp-button="Primary" onclick="logoutUser()">Close</a>
    </div>
}

<div class="d-flex flex-column align-items-start mt-5 mb-3">
    <h6>@L["Page:HelpfulLinks"]</h6>
    <ul>
        <li>
            <a class="btn btn-link fst-italic" href="@Url.Page("./Logout")">@L["Logout"]</a>
        </li>
    </ul>
</div>